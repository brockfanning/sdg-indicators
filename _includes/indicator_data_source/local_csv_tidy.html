<script type="text/javascript">

/**
 * An implementation of a data source for indicator data using local CSV files.
 */

var sdg_indicators = sdg_indicators || {};

(function() {

  // Implement the indicatorMapAdapter method.
  sdg_indicators.indicatorMapAdapter = function(e) {
    sdg_indicator_map_us({
      indicator_id: e.detail.indicator_id,
      data: e.detail.tidy,
      data_column_year: 'year',
      data_column_value: 'value',
      data_column_region: 'region'
    });
  }

  // Implement the indicatorTableAdapter method.
  sdg_indicators.indicatorTableAdapter = function(e) {
    var columns = Object.keys(e.detail.wide[0]);
    columns = columns.filter(function(x) { return x != 'year' && x != 'all'; });
    columns.sort();
    columns.unshift('year', 'all');

    sdg_indicators.indicatorTable(columns, e.detail.wide);
  };

  {% case include.graph_type %}
  {% when 'line' %}
  // Implement the indicatorGraphLineAdapter method.
  sdg_indicators.indicatorGraphLineAdapter = function(e) {
    sdg_indicators.indicatorGraphLine(e.detail.years, e.detail.values);
  };
  {% when 'line-rate' %}
  // Implement the indicatorGraphLineRateAdapter method.
  sdg_indicators.indicatorGraphLineRateAdapter = function(e) {
    sdg_indicators.indicatorGraphLineRate(e.detail.years, e.detail.values);
  };
  {% when 'bar' %}
  // Implement the indicatorGraphBarAdapter method.
  sdg_indicators.indicatorGraphBarAdapter = function(e) {
    sdg_indicators.indicatorGraphBar(e.detail.years, e.detail.values);
  };
  {% when 'bar-rate' %}
  // Implement the indicatorGraphBarRateAdapter method.
  sdg_indicators.indicatorGraphBarRateAdapter = function(e) {
    sdg_indicators.indicatorGraphBarRate(e.detail.years, e.detail.values);
  };
  {% when 'binary' %}
  // Implement the indicatorGraphBinaryAdapter method.
  sdg_indicators.indicatorGraphBinaryAdapter = function(e) {
    sdg_indicators.indicatorGraphBinary(e.detail.years, e.detail.values);
  };
  {% endcase %}

  // Guess the CSV file name.
  {% assign slug = page.indicator | replace: '.', '-' %}
  {% assign dataset_name = 'indicator_' | append: slug %}
  var csv_path = '{{ site.baseurl }}/data/tidy/{{ dataset_name }}.csv';

  // Grab the CSV data.
  $.when($.get(csv_path)).then(function(data) {

    var rows = $.csv.toObjects(data);
    var columns = Object.keys(rows[0]);

    // For tidy CSV, the main series is the one with only "year" and "value".
    var otherCols = columns.filter(function(x) { return x != 'year' && x != 'value'; });
    var mainSeries = rows.filter(function(x) { return otherCols.every(function(y) { return !x[y]; })});

    // For the data table we want to convert tidy to wide. Each value in the
    // non-value/year columns can be a separate column in the wide format.
    var wide = {};
    // First add the main series.
    mainSeries.forEach(function(row) {
      wide[row.year] = { year: row.year, all: row.value };
    });
    // Add other columns if necessary.
    if (otherCols) {
      rows.forEach(function(row) {
        otherCols.forEach(function(otherCol) {
          if (row[otherCol]) {
            wide[row.year][row[otherCol]] = row.value;
          }
        });
      });
    }

    document.dispatchEvent(new CustomEvent('IndicatorDataReady', {
      detail: {
        // A single series for the visualizations.
        years: mainSeries.map(function(x) { return x.year; }),
        values: mainSeries.map(function(x) { return x.value; }),
        // All of the data for the data table.
        wide: Object.values(wide),
        // Tidy data for the map.
        tidy: rows,
        indicator_id: '{{ slug }}'
      }
    }));
  });
})();

</script>